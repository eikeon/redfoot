<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
   xmlns:redfoot="http://redfoot.net/2005/redfoot#"
   xmlns:server="http://redfoot.net/2005/server#"
   xmlns:template="http://redfoot.net/2005/template#"
>  

  <redfoot:Namespace rdf:about="#">
    <rdfs:label>Redfoot server namespace</rdfs:label>
    <rdfs:comment>
    </rdfs:comment>
  </redfoot:Namespace>

  <rdfs:Class rdf:ID="Server">
    <rdfs:label>Server</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:subClassOf rdf:resource="http://redfoot.net/2005/redfoot#Module"/>
  </rdfs:Class>

  <rdf:Property rdf:ID="server">
    <rdfs:label>server</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/redfoot#Kernel"/>
    <rdfs:range rdf:resource="#Server"/>
  </rdf:Property>

  <rdfs:Class rdf:ID="Handler">
    <rdfs:label>Server Handler</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:subClassOf rdf:resource="http://redfoot.net/2005/redfoot#Code"/>
  </rdfs:Class>

  <rdf:Property rdf:ID="handler">
    <rdfs:label>server handler</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/redfoot#Kernel"/>
    <rdfs:domain rdf:resource="#Server"/>
    <rdfs:range rdf:resource="#Handler"/>
  </rdf:Property>

  <rdfs:Class rdf:ID="Site">
    <rdfs:label>Site</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:subClassOf rdf:resource="http://redfoot.net/2005/redfoot#Resource"/>
    <server:allow rdf:resource="#Admin"/>
    <template:content>
      <server:PagePartHandler rdf:ID="site_handler">
        <rdfs:label>file handler</rdfs:label>
        <rdf:value rdf:datatype="http://redfoot.net/2005/server#Kid">
<![CDATA[
<div xmlns:kid="http://purl.org/kid/ns#" kid:strip="">
<?python
Site = URIRef("http://redfoot.net/2005/server#Site")
allowed = allow(Site)

action = request.parameters.get("action")
label = request.parameters.get("label")
site = request.uri.abstract()
if action=="set_label":
    # TODO: ah... we should have get_context just do the context_id bit.
    context = redfoot.get_context(redfoot.context_id(site, context_id="context"))
    if allowed:
        redfoot.remove((site, RDFS.label, None))
        context.add((site, RDFS.label, Literal(label)))
site_label = redfoot.value(site, RDFS.label, any=True)

aspects = []
for aspect in redfoot.subjects(RDF.type, URIRef("http://redfoot.net/hypercode/aspect#Aspect")):
    redfoot.check(aspect)
    label = redfoot.label(aspect) or aspect
    aspects.append((label, aspect))
aspects.sort()

import rdflib, redfootlib, twisted, kid
?>

  <form kid:if="allowed" method="POST" action="" style="display: inline">
    <p kid:if="allowed">Set Site Label:
      <input type="text" name="label" value="${site_label}"/>
      <input type="submit" name="action" value="set_label"/>
    </p>
  </form>

  <span kid:if="allowed" kid:strip="">  
  <h3>Aspects</h3>
  <ul>
    <li kid:for="label, aspect in aspects">
      <a href="${request.relative(aspect.concrete())}">${label}</a>
    </li>
  </ul>
  </span>

  <h3>Version Info</h3>
  <ul>
    <li>redfoot: ${redfootlib.__version__}</li>
    <li>rdflib: ${rdflib.__version__} (${rdflib.__date__})</li>
    <li>kernel: ${redfoot_program}</li>
    <li>twisted: ${twisted.__version__}</li>
    <li>kid: ${kid.__version__}</li>
  </ul>

  <h3>Stats</h3>
  <ul>
    <li>Number of Triples: ${len(redfoot)}</li>
    <li>Number of Contexts: ${len(list(redfoot.contexts()))}</li>
  </ul>

</div>
]]>
        </rdf:value>
      </server:PagePartHandler>
    </template:content>
  </rdfs:Class>

  <rdf:Property rdf:ID="site">
    <rdfs:label>site</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:range rdf:resource="#Site"/>
  </rdf:Property>

  <rdfs:Class rdf:ID="Page">
    <rdfs:label>Page</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:subClassOf rdf:resource="http://redfoot.net/2005/redfoot#Resource"/>
  </rdfs:Class>

  <rdfs:Class rdf:ID="StaticPage">
    <rdfs:label>Static Page</rdfs:label>
    <rdfs:comment>A page that is served from the filesystem or somesuch.</rdfs:comment>
    <rdfs:subClassOf rdf:resource="http://redfoot.net/2005/redfoot#Resource"/>
    <server:page_handler>
      <server:PageHandler rdf:ID="file_handler">
        <rdfs:label>file handler</rdfs:label>
        <server:long_running>true<server:long_running>
        <rdf:value rdf:datatype="http://redfoot.net/2005/redfoot#Python">
<![CDATA[
import os
from os.path import join, exists
from base64 import b64decode

base64Binary = URIRef("http://www.w3.org/2001/XMLSchema#base64Binary")

content_type = redfoot.value(request.uri, SERVER.content_type)
if content_type:
    response.setHeader('Content-Type', content_type)

# TODO: grab root for site instead of hard-coded value of html
html_root = "html"

path = request.uri.replace(request.host, '.')
# TODO: url2pathname

if ".." not in path:
    filename = join(os.getcwd(), join(html_root, path))

    # TODO: support if-modified-since as well as sending last-modified
    if exists(filename):
        #redfoot.log.info("Serving from html dir: %s" % filename)
        f = file(filename)
        response.write(f.read())
        f.close()
    else:
        #redfoot.log.info("Serving from rdf: %s" % filename)
        value = redfoot.value(request.uri, RDF.value)
        if value:
            if value.datatype==base64Binary:
                response.write(b64decode(value))
            else:
                response.write(value)

]]>
        </rdf:value>
      </server:PageHandler>
    </server:page_handler>
  </rdfs:Class>

  <rdfs:Class rdf:ID="PageHandler">
    <rdfs:label>Page Handler</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:subClassOf rdf:resource="http://redfoot.net/2005/redfoot#Code"/>
  </rdfs:Class>

  <rdfs:Class rdf:ID="PagePartHandler">
    <rdfs:label>Page Part Handler</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:subClassOf rdf:resource="http://redfoot.net/2005/redfoot#Code"/>
  </rdfs:Class>

  <rdf:Property rdf:ID="page_handler">
    <rdfs:label>page handler</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="#Site"/>
    <rdfs:domain rdf:resource="#Page"/>
    <rdfs:range rdf:resource="#PageHandler"/>
  </rdf:Property>

  <rdf:Property rdf:ID="unauthorized_page_handler">
    <rdfs:label>unauthorized page handler</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="#Site"/>
    <rdfs:domain rdf:resource="#Page"/>
    <rdfs:range rdf:resource="#Handler"/>
  </rdf:Property>

  <rdf:Property rdf:ID="unauthorized_content_handler">
    <rdfs:label>unauthorized content handler</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="#Site"/>
    <rdfs:domain rdf:resource="#Page"/>
    <rdfs:range rdf:resource="#Handler"/>
  </rdf:Property>

  <rdf:Property rdf:ID="allow">
    <rdfs:label>allow</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/redfoot#Kernel"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Site"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Page"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#PagePartHandler"/>
    <rdfs:range rdf:resource="http://www.w3.org/2000/01/rdf-schema#Class"/> <!-- TODO make this more specific.. Agent? -->
  </rdf:Property>

  <rdf:Property rdf:ID="session_support">
    <rdfs:label>session support</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Handler"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/redfoot#Kernel"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Site"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Page"/>
  </rdf:Property>

  <rdf:Property rdf:ID="display_support">
    <rdfs:label>display support</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/redfoot#Kernel"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Site"/>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Page"/>
  </rdf:Property>

  <rdfs:Datatype rdf:ID="Kid">
    <rdfs:label>Kid</rdfs:label>
    <rdfs:comment></rdfs:comment>
  </rdfs:Datatype>

  <rdf:Property rdf:ID="content_type">
    <rdfs:label>content_type</rdfs:label>
    <rdfs:comment></rdfs:comment>
  </rdf:Property>

  <rdf:Property rdf:ID="supported_content_types">
    <rdfs:label>supported_content_types</rdfs:label>
    <rdfs:comment></rdfs:comment>
  </rdf:Property>

  <rdf:Property rdf:ID="alternate">
    <rdfs:label>alternate</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="http://redfoot.net/2005/server#Page"/>
    <rdfs:range rdf:resource="http://redfoot.net/2005/server#Page"/>
  </rdf:Property>

  <rdf:Property rdf:ID="long_running">
    <rdfs:label>long running</rdfs:label>
    <rdfs:comment>Used to indicate that the caculation of the page may take some time</rdfs:comment>
    <rdfs:domain rdf:resource="#Page"/>
    <!--<rdfs:range rdf:resource="#Handler"/>-->
  </rdf:Property>

  <rdf:Property rdf:ID="last_modified">
    <rdfs:label>last modified</rdfs:label>
    <rdfs:comment>Used to indicate the value of the HTTP headr last modified in seconds since epoch</rdfs:comment>
    <rdfs:domain rdf:resource="#Site"/>
    <rdfs:domain rdf:resource="#Page"/>
    <rdfs:range rdf:resource="http://www.w3.org/2000/01/rdf-schema#Literal"/> <!-- seconds since epoch -->
  </rdf:Property>

  <rdf:Property rdf:ID="etag">
    <rdfs:label>etag</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <rdfs:domain rdf:resource="#CachedPage"/>
    <rdfs:range rdf:resource="http://www.w3.org/2000/01/rdf-schema#Literal"/>
  </rdf:Property>

</rdf:RDF>  
