<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
   xmlns:redfoot="http://redfoot.net/2005/redfoot#"
   xmlns:commands="http://redfoot.net/2005/commands#"
   xmlns:server="http://redfoot.net/2005/server#"
   xmlns:session="http://redfoot.net/2005/session#"
   xmlns:template='http://redfoot.net/2005/template#'
>

  <redfoot:Aspect rdf:ID="contexts_aspect">
    <rdfs:label>context listing support</rdfs:label>
    <rdfs:comment>
    </rdfs:comment>
  </redfoot:Aspect>

  <rdf:Description rdf:about="">
    <template:section rdf:resource="/contexts/"/>    
  </rdf:Description>

  <server:Page rdf:about="/contexts/">
    <rdfs:label>Contexts</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <template:default_section_rank>80.0</template:default_section_rank>
    <template:content rdf:resource="#contexts"/>
  </server:Page>

  <server:PagePartHandler rdf:ID="contexts">
    <server:allow rdf:resource="#Admin"/>
    <rdf:value rdf:datatype="http://redfoot.net/2005/server#Kid">
<![CDATA[

  <span xmlns:kid="http://purl.org/kid/ns#" kid:omit="">
<?python
contexts = []
for context in redfoot.contexts():
    if isinstance(context, URIRef):
        label = redfoot.label(context) or context
        #if not label:
        #    abstract = URIRef("%s#" % redfoot.context_id(context, context_id=""))
        #    label = redfoot.label(abstract) or context
        contexts.append((label, context))
contexts.sort()
?>
  <ul>
    <li kid:for="label, context in contexts">
      <a href="${request.relative(context.concrete())}">
        ${label}
      </a>
    </li>
  </ul>
  </span>
]]>
    </rdf:value>
  </server:PagePartHandler>

  <server:Page rdf:about="/rdfxml">
    <rdfs:label>rdfxml</rdfs:label>
    <rdfs:comment></rdfs:comment>
    <server:page_handler>
      <redfoot:Python rdf:about="rdfxml">
        <server:content_type>application/rdf+xml</server:content_type>      
        <rdf:value rdf:datatype="http://redfoot.net/2005/redfoot#Python"><![CDATA[

# Make sure all contexts have RDF.type of REDFOOT.Context
for context in redfoot.contexts():
    if not (context, RDF.type, REDFOOT.DeletedContext) in redfoot:
        redfoot.index.add((context, RDF.type, REDFOOT.Context))

cid = request.parameters.get("uri", None)
print cid
if cid:
    cid = URIRef(cid)
    cid = cid.abstract()
else:
    cid = request.parameters.get("bnode", None)
    if cid:
        cid = BNode(cid)
    else:
        print "no context specified... assuming index"
        cid = redfoot.index.identifier
        #TODO: 404
g = redfoot.get_context(cid)
g.serialize(destination=response, format="pretty-xml")

      ]]></rdf:value>
      </redfoot:Python>
    </server:page_handler>
  </server:Page>

</rdf:RDF>  
