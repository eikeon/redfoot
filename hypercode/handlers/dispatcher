<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
   xmlns:redfoot="http://redfoot.net/2005/redfoot#"
   xmlns:server="http://redfoot.net/2005/01/server#"
   xmlns:handler="http://redfoot.net/2005/01/handler#"
>

  <server:Handler rdf:about="#">
    <rdfs:label>dispatch handler</rdfs:label>      
    <server:dispatcher_handler rdf:resource="page#"/>
    <rdf:value rdf:datatype="http://redfoot.net/2005/redfoot#Python">
<![CDATA[

HANDLER = redfoot.namespace("http://redfoot.net/2005/01/handler#")
SESSION = redfoot.namespace("http://redfoot.net/2005/01/session#")

from rdflib.util import date_time

# add request.session_id
sid = request.getCookie("session_id", None)
if sid is None:

    from string import ascii_letters
    from random import choice
    import md5, time
    m = md5.new()
    m.update(str([choice(ascii_letters) for i in xrange(0, 8)]))
    m.update(str(time.time()))
    #m.update(request.getClientIP())
    sid = m.hexdigest()
    response.addCookie('session_id=%s;path=/' % sid)
request.session_id = session_id = URIRef("%s/sessions#%s" % (request.host, sid))
if (session_id, RDF.type, SESSION.Session) not in redfoot:
    context = redfoot.get_context(redfoot.context_id(session_id))
    context.add((session_id, RDF.type, SESSION.Session))
    context.add((session_id, SESSION.created, Literal(date_time())))

request.uri = URIRef(request.uri.split(";", 1)[-1])

if not "://" in request.uri:
    request.uri = URIRef(request.uri.replace(":/", "://"))

request.uris = uris = []
for uri in request.uri.split("+"):
    uris.append(URIRef(uri))

handler = redfoot.value(request.uri, HANDLER.handler) or redfoot.value(request.host, HANDLER.handler) or redfoot.value(redfoot.uri, HANDLER.handler)

lookup_list = [request.uri, request.host, redfoot.uri]
print "?????", redfoot.lookup
handler = redfoot.lookup(HANDLER.handler, lookup_list)



if handler:
    redfoot.execute(handler, request=request, response=response)
else:
    response.setHeader('Content-Type', 'text/html; charset=UTF-8')            
    # TODO: rename to setStatus
    response.setStatus(404, "Handler Not Found")
    response.write("""
<html>
<head>
<title>Handler Not Found</title>
</head>
<h1>Handler Not Found</h1>
</html>
""")
]]>
    </rdf:value>
  </server:Handler>

</rdf:RDF>  
